Looks like a complex dfs type question, turns out to be an relatively easy dp question.
